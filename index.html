<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kahuto Pacific ‚Äî Survey Area Definer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:#0B1A2E;color:#F0F4F8;overflow:hidden;height:100vh}

.hdr{position:fixed;top:0;left:0;right:0;z-index:1000;display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:rgba(11,26,46,.96);border-bottom:1px solid rgba(0,180,160,.15);backdrop-filter:blur(12px)}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:34px;height:34px;background:linear-gradient(135deg,#00B4A0,#4EEAE0);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;color:#0B1A2E}
.brand h1{font-size:15px;font-weight:700}
.brand small{font-size:9px;color:#00B4A0;letter-spacing:2px;text-transform:uppercase}
.hdr-btns{display:flex;gap:8px}

.btn{font-family:inherit;font-size:12px;font-weight:600;border:none;border-radius:8px;padding:9px 16px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:all .15s}
.btn-p{background:linear-gradient(135deg,#00B4A0,#00D4BC);color:#0B1A2E}
.btn-p:hover{box-shadow:0 4px 16px rgba(0,180,160,.35);transform:translateY(-1px)}
.btn-s{background:rgba(0,180,160,.1);color:#00B4A0;border:1px solid rgba(0,180,160,.18)}
.btn-s:hover{background:rgba(0,180,160,.2)}
.btn-d{background:rgba(255,107,90,.08);color:#FF6B5A;border:1px solid rgba(255,107,90,.18)}
.btn-d:hover{background:rgba(255,107,90,.18)}

#map{position:fixed;top:54px;left:0;right:340px;bottom:0;z-index:1;background:#0a1628}

.panel{position:fixed;top:54px;right:0;bottom:0;width:340px;z-index:1000;background:rgba(11,26,46,.97);border-left:1px solid rgba(0,180,160,.12);display:flex;flex-direction:column;overflow:hidden}
.ps{padding:14px 16px;border-bottom:1px solid rgba(0,180,160,.1)}
.ps h3{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:#7A8FA6;margin-bottom:10px}
.pi{width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:7px;padding:8px 11px;color:#F0F4F8;font-family:inherit;font-size:13px;outline:none;display:block}
.pi:focus{border-color:#00B4A0}
.pi+.pi{margin-top:8px}
select.pi option{background:#122744;color:#F0F4F8}
textarea.pi{resize:vertical;min-height:50px}

.stats{display:flex;border-bottom:1px solid rgba(0,180,160,.1);background:rgba(0,180,160,.03)}
.stat{flex:1;text-align:center;padding:10px 0}
.stat b{display:block;font-family:monospace;font-size:18px;color:#00B4A0}
.stat span{font-size:8px;text-transform:uppercase;letter-spacing:1.5px;color:#7A8FA6}

.layers{flex:1;overflow-y:auto;padding:8px 12px}
.layers::-webkit-scrollbar{width:4px}
.layers::-webkit-scrollbar-thumb{background:#00B4A0;border-radius:4px}

.empty{text-align:center;padding:36px 16px;color:#7A8FA6}
.empty .icon{font-size:40px;margin-bottom:10px;opacity:.4}
.empty p{font-size:13px;line-height:1.6}

.li{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:9px;padding:10px 12px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.li:hover{border-color:rgba(0,180,160,.3);background:rgba(0,180,160,.06)}
.li-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.li-tag{font-family:monospace;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;padding:2px 7px;border-radius:4px}
.li-tag.polygon{background:rgba(78,234,224,.12);color:#4EEAE0}
.li-tag.polyline{background:rgba(245,230,200,.12);color:#F5E6C8}
.li-tag.rectangle{background:rgba(100,180,255,.12);color:#64b4ff}
.li-tag.circle{background:rgba(200,140,255,.12);color:#c88cff}
.li-tag.marker{background:rgba(255,107,90,.12);color:#FF6B5A}
.li-del{background:none;border:none;color:#7A8FA6;cursor:pointer;font-size:14px;padding:2px 6px;border-radius:4px}
.li-del:hover{color:#FF6B5A;background:rgba(255,107,90,.1)}
.li-info{font-size:11px;color:#7A8FA6}

.pf{padding:12px 16px;border-top:1px solid rgba(0,180,160,.1)}
.pf .btn{width:100%;justify-content:center}

.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:#122744;border:1px solid #00B4A0;color:#F0F4F8;padding:10px 24px;border-radius:10px;font-size:13px;font-weight:500;z-index:9999;opacity:0;transition:all .35s cubic-bezier(.4,0,.2,1);pointer-events:none;box-shadow:0 8px 32px rgba(0,0,0,.5)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.intro-bg{position:fixed;inset:0;z-index:2000;background:rgba(11,26,46,.9);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center}
.intro-bg.hide{display:none}
.intro{background:#122744;border:1px solid rgba(0,180,160,.15);border-radius:18px;padding:40px;max-width:520px;width:92%;text-align:center}
.intro h2{font-size:22px;margin-bottom:4px}
.intro .sub{font-size:13px;color:#00B4A0;margin-bottom:26px}
.steps{text-align:left;display:flex;flex-direction:column;gap:16px;margin-bottom:30px}
.step{display:flex;gap:12px}
.step-n{min-width:30px;height:30px;background:rgba(0,180,160,.1);color:#00B4A0;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:monospace;font-weight:700;font-size:13px}
.step-t{font-size:14px;font-weight:600;padding-top:4px}
.step-s{font-size:12px;color:#7A8FA6;margin-top:2px}

.crd{position:fixed;bottom:12px;left:12px;z-index:1000;font-family:monospace;font-size:11px;color:#7A8FA6;background:rgba(11,26,46,.92);padding:6px 12px;border-radius:7px;border:1px solid rgba(0,180,160,.1)}

.pre-box{position:fixed;top:120px;left:12px;z-index:1001;background:rgba(11,26,46,.96);border-radius:10px;border:1px solid rgba(0,180,160,.15);padding:6px;width:210px;display:none}
.pre-box.show{display:block}
.pre-box .pl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:#7A8FA6;padding:6px 10px}
.pre-box button{display:block;width:100%;text-align:left;background:none;border:none;color:#F0F4F8;padding:8px 10px;font-size:12px;font-family:inherit;cursor:pointer;border-radius:6px}
.pre-box button:hover{background:rgba(0,180,160,.1)}

/* Leaflet overrides */
.leaflet-draw-toolbar a,.leaflet-bar a{background-color:#122744 !important;border-color:rgba(0,180,160,.2) !important;color:#00B4A0 !important}
.leaflet-draw-toolbar a:hover,.leaflet-bar a:hover{background-color:rgba(0,180,160,.15) !important}
.leaflet-control-attribution{background:rgba(11,26,46,.85) !important;color:#7A8FA6 !important;font-size:10px !important}
.leaflet-control-attribution a{color:#00B4A0 !important}

@media(max-width:800px){
  #map{right:0}
  .panel{display:none}
}
</style>
</head>
<body>

<header class="hdr">
  <div class="brand">
    <div class="logo">KP</div>
    <div><h1>Kahuto Pacific</h1><small>Survey Area Definer</small></div>
  </div>
  <div class="hdr-btns">
    <button class="btn btn-s" onclick="doImport()">üìÇ Import KML</button>
    <button class="btn btn-s" onclick="togglePre()">üåè Locations</button>
    <button class="btn btn-p" onclick="doExport()">üì• Export KML</button>
  </div>
</header>

<div id="map"></div>

<div class="panel">
  <div class="ps">
    <h3>Project Details</h3>
    <input class="pi" id="pName" placeholder="Project / Site Name">
    <select class="pi" id="pType">
      <option value="">Select survey type...</option>
      <option value="aerial-lidar">Aerial LiDAR Survey</option>
      <option value="utility-gpr">Utility Mapping (GPR)</option>
      <option value="terrestrial-scan">Terrestrial Laser Scanning</option>
      <option value="bathymetry">Bathymetry</option>
      <option value="drone-photogrammetry">Drone Photogrammetry</option>
      <option value="cadastral">Cadastral Survey</option>
      <option value="other">Other</option>
    </select>
    <textarea class="pi" id="pNotes" placeholder="Notes or special requirements..." rows="2"></textarea>
  </div>
  <div class="stats">
    <div class="stat"><b id="nS">0</b><span>Shapes</span></div>
    <div class="stat"><b id="nA">0</b><span>Hectares</span></div>
    <div class="stat"><b id="nL">0</b><span>km</span></div>
  </div>
  <div class="ps"><h3>Drawn Areas</h3></div>
  <div class="layers" id="lys"></div>
  <div class="pf" id="cf" style="display:none"><button class="btn btn-d" onclick="clrAll()">üóëÔ∏è Clear All</button></div>
</div>

<div class="crd" id="crd">‚Äî</div>

<div class="pre-box" id="preBox">
  <div class="pl">Jump to Location</div>
</div>

<div class="intro-bg" id="introBg">
  <div class="intro">
    <h2>Define Your Survey Area</h2>
    <p class="sub">Kahuto Pacific ‚Äî client tool</p>
    <div class="steps">
      <div class="step"><div class="step-n">1</div><div><div class="step-t">Navigate to your site</div><div class="step-s">Pan/zoom the satellite map or use üåè Locations to jump</div></div></div>
      <div class="step"><div class="step-n">2</div><div><div class="step-t">Use the drawing tools</div><div class="step-s">On the left of the map ‚Äî polygon, rectangle, line, or marker</div></div></div>
      <div class="step"><div class="step-n">3</div><div><div class="step-t">Fill in project details</div><div class="step-s">Project name, survey type, and any special notes on the right panel</div></div></div>
      <div class="step"><div class="step-n">4</div><div><div class="step-t">Export as KML</div><div class="step-s">Click Export KML and email the file to Kahuto Pacific</div></div></div>
    </div>
    <button class="btn btn-p" style="width:100%;justify-content:center;font-size:15px;padding:13px 0" onclick="document.getElementById('introBg').classList.add('hide')">Get Started</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="fi" accept=".kml" style="display:none">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
var items = []; // {id, type, layer}
var idCounter = 0;

// ‚îÄ‚îÄ Map ‚îÄ‚îÄ
var map = L.map('map', {center:[-18.1416,178.4419], zoom:13, zoomControl:false});
L.control.zoom({position:'bottomleft'}).addTo(map);

L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
  attribution:'Tiles &copy; Esri', maxZoom:19
}).addTo(map);

L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{
  maxZoom:19, opacity:0.75
}).addTo(map);

var fg = new L.FeatureGroup();
map.addLayer(fg);

var dc = new L.Control.Draw({
  position:'topleft',
  draw:{
    polygon:{ allowIntersection:false, shapeOptions:{color:'#00B4A0',weight:2,fillColor:'#00B4A0',fillOpacity:0.15}},
    polyline:{ shapeOptions:{color:'#F5E6C8',weight:3}},
    rectangle:{ shapeOptions:{color:'#64b4ff',weight:2,fillColor:'#64b4ff',fillOpacity:0.15}},
    circle:{ shapeOptions:{color:'#c88cff',weight:2,fillColor:'#c88cff',fillOpacity:0.15}},
    marker:true,
    circlemarker:false
  },
  edit:{ featureGroup:fg, remove:true }
});
map.addControl(dc);

// ‚îÄ‚îÄ Coord display ‚îÄ‚îÄ
map.on('mousemove',function(e){
  document.getElementById('crd').textContent = e.latlng.lat.toFixed(6)+', '+e.latlng.lng.toFixed(6)+' ¬∑ Zoom '+map.getZoom();
});

// ‚îÄ‚îÄ Draw events ‚îÄ‚îÄ
map.on(L.Draw.Event.CREATED,function(e){
  var layer=e.layer, type=e.layerType;
  idCounter++;
  layer._cid=idCounter; layer._ctype=type;
  fg.addLayer(layer);
  items.push({id:idCounter, type:type, layer:layer});
  updUI(); flash(typeLabel(type)+' added');
});
map.on(L.Draw.Event.DELETED,function(e){
  e.layers.eachLayer(function(l){ items=items.filter(function(x){return x.layer!==l}); });
  updUI();
});
map.on(L.Draw.Event.EDITED,function(){ updUI(); });

// ‚îÄ‚îÄ Presets ‚îÄ‚îÄ
var LOCS=[
  {n:'Suva, Fiji',la:-18.1416,ln:178.4419,z:13},
  {n:'Nadi, Fiji',la:-17.7765,ln:177.95,z:13},
  {n:'Nausori, Fiji',la:-18.0194,ln:178.525,z:14},
  {n:'Lautoka, Fiji',la:-17.6161,ln:177.4509,z:14},
  {n:'Labasa, Fiji',la:-16.4267,ln:179.364,z:14},
  {n:'Port Moresby, PNG',la:-9.4438,ln:147.1803,z:13},
  {n:'Lae, PNG',la:-6.7340,ln:147.0026,z:13},
  {n:'Port Vila, Vanuatu',la:-17.7334,ln:168.3273,z:13},
  {n:'Honiara, Solomon Is.',la:-9.4295,ln:159.9729,z:13}
];
var pb=document.getElementById('preBox');
LOCS.forEach(function(p){
  var b=document.createElement('button');
  b.textContent=p.n;
  b.onclick=function(){map.setView([p.la,p.ln],p.z);pb.classList.remove('show')};
  pb.appendChild(b);
});
function togglePre(){pb.classList.toggle('show')}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function typeLabel(t){return{polygon:'Polygon',polyline:'Line',rectangle:'Rectangle',circle:'Circle',marker:'Marker'}[t]||t}

function calcArea(layer){
  if(layer instanceof L.Circle) return Math.PI*Math.pow(layer.getRadius(),2);
  if(!layer.getLatLngs) return 0;
  var ll=layer.getLatLngs(), flat=Array.isArray(ll[0])?ll[0]:ll;
  if(flat.length<3) return 0;
  var R=6371000,r=Math.PI/180,a=0;
  for(var i=0;i<flat.length;i++){
    var j=(i+1)%flat.length;
    a+=flat[i].lng*r*R*Math.cos(flat[i].lat*r)*(flat[j].lat*r*R)-(flat[j].lng*r*R*Math.cos(flat[j].lat*r))*(flat[i].lat*r*R);
  }
  return Math.abs(a)/2;
}
function calcLen(layer){
  if(!layer.getLatLngs) return 0;
  var ll=layer.getLatLngs(), flat=Array.isArray(ll[0])?ll[0]:ll, l=0;
  for(var i=1;i<flat.length;i++) l+=flat[i-1].distanceTo(flat[i]);
  return l;
}
function fA(m){var h=m/10000;return h<0.01?m.toFixed(0)+' m¬≤':h.toFixed(2)+' ha'}
function fL(m){return m<1000?m.toFixed(0)+' m':(m/1000).toFixed(2)+' km'}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ
function updUI(){
  document.getElementById('nS').textContent=items.length;
  var ta=0,tl=0;
  items.forEach(function(x){
    if(x.type==='polygon'||x.type==='rectangle'||x.type==='circle') ta+=calcArea(x.layer);
    if(x.type==='polyline') tl+=calcLen(x.layer);
  });
  document.getElementById('nA').textContent=(ta/10000).toFixed(1);
  document.getElementById('nL').textContent=(tl/1000).toFixed(1);
  document.getElementById('cf').style.display=items.length?'block':'none';

  var el=document.getElementById('lys');
  if(!items.length){
    el.innerHTML='<div class="empty"><div class="icon">üó∫Ô∏è</div><p>Use the <strong style="color:#00B4A0">drawing tools</strong> on the left side of the map to mark your survey areas.</p></div>';
    return;
  }
  el.innerHTML=items.map(function(x,i){
    var info='';
    if(x.type==='polygon'||x.type==='rectangle'||x.type==='circle'){
      info='‚óª '+fA(calcArea(x.layer));
      if(x.type!=='circle') info+=' ¬∑ '+fL(calcLen(x.layer))+' perim';
    } else if(x.type==='polyline'){
      info='‚Üî '+fL(calcLen(x.layer));
    } else if(x.type==='marker'){
      var ll=x.layer.getLatLng();
      info='üìç '+ll.lat.toFixed(5)+', '+ll.lng.toFixed(5);
    }
    return '<div class="li" onclick="zoomTo('+x.id+')"><div class="li-top"><span class="li-tag '+x.type+'">'+typeLabel(x.type)+'</span><button class="li-del" onclick="event.stopPropagation();delItem('+x.id+')" title="Delete">‚úï</button></div><div class="li-info">'+info+'</div></div>';
  }).join('');
}

function zoomTo(id){
  var x=items.find(function(i){return i.id===id});
  if(!x)return;
  if(x.layer.getBounds) map.fitBounds(x.layer.getBounds().pad(0.3));
  else if(x.layer.getLatLng) map.setView(x.layer.getLatLng(),17);
}
function delItem(id){
  var x=items.find(function(i){return i.id===id});
  if(!x)return;
  fg.removeLayer(x.layer);
  items=items.filter(function(i){return i.id!==id});
  updUI(); flash('Shape removed');
}
function clrAll(){
  if(!confirm('Clear all drawn areas?'))return;
  fg.clearLayers(); items=[];
  updUI(); flash('All cleared');
}

// ‚îÄ‚îÄ KML Export ‚îÄ‚îÄ
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

function doExport(){
  if(!items.length){flash('Draw at least one area first');return}
  var pn=document.getElementById('pName').value||'Survey Area';
  var pt=document.getElementById('pType').value;
  var pno=document.getElementById('pNotes').value||'';
  var stL={'aerial-lidar':'Aerial LiDAR Survey','utility-gpr':'Utility Mapping (GPR)','terrestrial-scan':'Terrestrial Laser Scanning','bathymetry':'Bathymetry','drone-photogrammetry':'Drone Photogrammetry','cadastral':'Cadastral Survey','other':'Other'};

  // Build <name> tags via concatenation so browser doesn't eat them
  var NO = String.fromCharCode(60)+'name'+String.fromCharCode(62);
  var NC = String.fromCharCode(60)+'/name'+String.fromCharCode(62);

  var pms=items.map(function(x,i){
    var geo='',desc='',nm=typeLabel(x.type)+' '+(i+1);
    var layer=x.layer, type=x.type;

    if(type==='marker'){
      var ll=layer.getLatLng();
      geo='<Point><coordinates>'+ll.lng+','+ll.lat+',0</coordinates></Point>';
      desc='Point: '+ll.lat.toFixed(6)+', '+ll.lng.toFixed(6);
    }
    else if(type==='circle'){
      var cen=layer.getLatLng(), rad=layer.getRadius(), pts=36, coords='';
      for(var k=0;k<=pts;k++){
        var ang=k/pts*2*Math.PI;
        var dlat=(rad/111320)*Math.cos(ang);
        var dlng=(rad/(111320*Math.cos(cen.lat*Math.PI/180)))*Math.sin(ang);
        coords+=(cen.lng+dlng).toFixed(8)+','+(cen.lat+dlat).toFixed(8)+',0 ';
      }
      geo='<Polygon><outerBoundaryIs><LinearRing><coordinates>'+coords.trim()+'</coordinates></LinearRing></outerBoundaryIs></Polygon>';
      desc='Area: '+fA(calcArea(layer));
    }
    else if(type==='polygon'||type==='rectangle'){
      var lls=layer.getLatLngs(), flat=Array.isArray(lls[0])?lls[0]:lls;
      var cs=flat.map(function(c){return c.lng.toFixed(8)+','+c.lat.toFixed(8)+',0'}).join(' ');
      cs+=' '+flat[0].lng.toFixed(8)+','+flat[0].lat.toFixed(8)+',0';
      geo='<Polygon><outerBoundaryIs><LinearRing><coordinates>'+cs+'</coordinates></LinearRing></outerBoundaryIs></Polygon>';
      desc='Area: '+fA(calcArea(layer));
    }
    else if(type==='polyline'){
      var lls=layer.getLatLngs();
      var cs=lls.map(function(c){return c.lng.toFixed(8)+','+c.lat.toFixed(8)+',0'}).join(' ');
      geo='<LineString><coordinates>'+cs+'</coordinates></LineString>';
      desc='Length: '+fL(calcLen(layer));
    }

    return '  <Placemark>\n    '+NO+esc(nm)+NC+'\n    <description>'+esc(desc)+'</description>\n    '+geo+'\n  </Placemark>';
  }).join('\n');

  var kml='<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n  '+NO+esc(pn)+NC+'\n  <description>Survey Type: '+esc(stL[pt]||'Not specified')+'\nNotes: '+esc(pno)+'\nGenerated: '+new Date().toISOString()+'\nTool: Kahuto Pacific Survey Area Definer</description>\n'+pms+'\n</Document>\n</kml>';

  var blob=new Blob([kml],{type:'application/vnd.google-earth.kml+xml'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=pn.replace(/[^a-zA-Z0-9]/g,'_')+'_survey_area.kml';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
  flash('KML exported!');
}

// ‚îÄ‚îÄ KML Import ‚îÄ‚îÄ
var fi=document.getElementById('fi');
function doImport(){fi.click()}
fi.addEventListener('change',function(e){
  var f=e.target.files[0];if(!f)return;
  var reader=new FileReader();
  reader.onload=function(ev){
    try{
      var doc=new DOMParser().parseFromString(ev.target.result,'text/xml');
      if(doc.querySelector('parsererror')){flash('Invalid KML ‚Äî could not parse');return}
      var ct=0;
      doc.querySelectorAll('Placemark').forEach(function(pm){
        var pt=pm.querySelector('Point coordinates');
        if(pt){
          var p=pt.textContent.trim().split(',');
          if(p.length>=2){var lng=+p[0],lat=+p[1];
            if(!isNaN(lat)&&!isNaN(lng)){
              var m=L.marker([lat,lng]);
              idCounter++; m._cid=idCounter; m._ctype='marker';
              fg.addLayer(m);
              items.push({id:idCounter,type:'marker',layer:m}); ct++;
            }
          }
        }
        var pg=pm.querySelector('Polygon outerBoundaryIs LinearRing coordinates');
        if(pg){
          var coords=parseKC(pg.textContent);
          if(coords.length>=3){
            if(coords[0][0]===coords[coords.length-1][0]&&coords[0][1]===coords[coords.length-1][1]) coords.pop();
            var poly=L.polygon(coords,{color:'#00B4A0',weight:2,fillColor:'#00B4A0',fillOpacity:0.15});
            idCounter++; poly._cid=idCounter; poly._ctype='polygon';
            fg.addLayer(poly);
            items.push({id:idCounter,type:'polygon',layer:poly}); ct++;
          }
        }
        var ln=pm.querySelector('LineString coordinates');
        if(ln){
          var coords=parseKC(ln.textContent);
          if(coords.length>=2){
            var line=L.polyline(coords,{color:'#F5E6C8',weight:3});
            idCounter++; line._cid=idCounter; line._ctype='polyline';
            fg.addLayer(line);
            items.push({id:idCounter,type:'polyline',layer:line}); ct++;
          }
        }
      });
      if(!ct){flash('No valid shapes found');return}
      map.fitBounds(fg.getBounds().pad(0.2));
      var dn=doc.querySelector('Document > name');
      if(dn&&dn.textContent) document.getElementById('pName').value=dn.textContent;
      updUI();
      flash('Imported '+ct+' shape'+(ct>1?'s':''));
    }catch(err){flash('Error reading KML');console.error(err)}
  };
  reader.readAsText(f);
  fi.value='';
});

function parseKC(t){
  return t.trim().split(/\s+/).map(function(c){
    var p=c.split(',');
    if(p.length>=2){var lng=+p[0],lat=+p[1];if(!isNaN(lat)&&!isNaN(lng))return[lat,lng]}
    return null;
  }).filter(Boolean);
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
var tt;
function flash(m){
  var t=document.getElementById('toast');
  t.textContent=m;t.classList.add('show');
  clearTimeout(tt);
  tt=setTimeout(function(){t.classList.remove('show')},3000);
}

// ‚îÄ‚îÄ Escape key ‚îÄ‚îÄ
document.addEventListener('keydown',function(e){
  if(e.key==='Escape') document.getElementById('introBg').classList.add('hide');
});

// Init
updUI();
</script>
</body>
</html>
